{% extends "base.html" %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Tournament Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>{{ tournament.name }}</h1>
            <p class="text-muted">{{ tournament.description }}</p>
        </div>
        <div class="text-end">
            <span class="badge bg-{{ 'success' if tournament.status == 'active' else 'secondary' }} fs-6">
                {{ tournament.status|title }}
            </span>
            <span class="badge bg-info fs-6">{{ tournament.tournament_type|replace('_', ' ')|title }}</span>
        </div>
    </div>

    <!-- Tournament Info -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tournament Information</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-calendar me-2"></i><strong>Start Date:</strong> {{ tournament.start_date.strftime('%B %d, %Y') }}</li>
                        <li><i class="fas fa-calendar me-2"></i><strong>End Date:</strong> {{ tournament.end_date.strftime('%B %d, %Y') }}</li>
                        <li><i class="fas fa-users me-2"></i><strong>Max Teams:</strong> {{ tournament.max_teams }}</li>
                        <li><i class="fas fa-trophy me-2"></i><strong>Current Stage:</strong> {{ tournament.current_stage|replace('_', ' ')|title }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Stats</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-users me-2"></i><strong>Teams:</strong> {{ tournament.teams|length }}</li>
                        <li><i class="fas fa-gamepad me-2"></i><strong>Matches:</strong> {{ tournament.matches|length }}</li>
                        <li><i class="fas fa-calendar-check me-2"></i><strong>Completed:</strong> {{ tournament.matches|selectattr('status', 'equalto', 'completed')|list|length }}</li>
                        <li><i class="fas fa-clock me-2"></i><strong>Scheduled:</strong> {{ tournament.matches|selectattr('status', 'equalto', 'scheduled')|list|length }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="tournamentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab">
                <i class="fas fa-layer-group me-2"></i>Groups
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">
                <i class="fas fa-users me-2"></i>All Teams ({{ tournament.teams|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button" role="tab">
                <i class="fas fa-gamepad me-2"></i>Matches ({{ tournament.matches|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="standings-tab" data-bs-toggle="tab" data-bs-target="#standings" type="button" role="tab">
                <i class="fas fa-list-ol me-2"></i>Standings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket" type="button" role="tab">
                <i class="fas fa-sitemap me-2"></i>Bracket
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="tournamentTabsContent">
        <!-- Groups Tab -->
        <div class="tab-pane fade show active" id="groups" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-layer-group me-2 text-primary"></i>
                    Group Stages
                </h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-lg" onclick="generateAllGroupMatches()">
                        <i class="fas fa-magic me-2"></i> Generate All Matches
                    </button>
                    <a href="{{ url_for('team.new_team') }}?tournament_id={{ tournament.id }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i> Add New Team
                    </a>
                </div>
            </div>
            
            {% for group in tournament.groups %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-layer-group me-3"></i>
                            Group {{ group.name }}
                        </h4>
                        <span class="badge bg-light text-primary fs-6 px-3 py-2">
                            <i class="fas fa-users me-1"></i>
                            {% set group_teams = group.teams %}
                            {{ group_teams|length }} Teams
                        </span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Add Team Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="add-team-section p-3 bg-light rounded">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-plus-circle me-2 text-success"></i>
                                    Add Team to Group {{ group.name }}
                                </h6>
                                <select class="form-select form-select-lg" id="addTeam{{ group.name }}" onchange="addTeamToGroup('{{ group.name }}', this.value)">
                                    <option value="">Select a team to add...</option>
                                    {% for team in tournament.teams %}
                                        {% if not team.group_id %}
                                            <option value="{{ team.id }}">{{ team.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Only unassigned teams are shown
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="group-stats p-3 bg-light rounded">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-chart-bar me-2 text-info"></i>
                                    Group {{ group.name }} Statistics
                                </h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <div class="stat-number text-primary fw-bold fs-4">
                                                {{ group.teams|length }}
                                            </div>
                                            <div class="stat-label text-muted small">Teams</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <div class="stat-number text-success fw-bold fs-4">
                                                {% set group_matches = tournament.matches|selectattr('group_name', 'equalto', group.name)|list %}
                                                {{ group_matches|length }}
                                            </div>
                                            <div class="stat-label text-muted small">Matches</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <div class="stat-number text-warning fw-bold fs-4">
                                                {% set completed_matches = tournament.matches|selectattr('group_name', 'equalto', group.name)|selectattr('status', 'equalto', 'completed')|list %}
                                                {{ completed_matches|length }}
                                            </div>
                                            <div class="stat-label text-muted small">Completed</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Teams in Group -->
                    {% set group_teams = group.teams %}
                    {% if group_teams %}
                        <div class="teams-section">
                            <h5 class="text-muted mb-3">
                                <i class="fas fa-users me-2 text-primary"></i>
                                Teams in Group {{ group.name }}
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-center" style="width: 5%;">#</th>
                                            <th class="text-start" style="width: 35%;">Team</th>
                                            <th class="text-center" style="width: 8%;">P</th>
                                            <th class="text-center" style="width: 8%;">W</th>
                                            <th class="text-center" style="width: 8%;">D</th>
                                            <th class="text-center" style="width: 8%;">L</th>
                                            <th class="text-center" style="width: 8%;">GF</th>
                                            <th class="text-center" style="width: 8%;">GA</th>
                                            <th class="text-center" style="width: 8%;">GD</th>
                                            <th class="text-center" style="width: 8%;">Pts</th>
                                            <th class="text-center" style="width: 6%;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set group_standings = tournament.get_group_standings(group.name) %}
                                        {% for standing in group_standings %}
                                        <tr class="align-middle">
                                            <td class="text-center fw-bold">{{ loop.index }}</td>
                                            <td class="text-start">
                                                <div class="d-flex align-items-center">
                                                    {% if standing.team.logo_url %}
                                                        <img src="{{ standing.team.logo_url }}" alt="{{ standing.team.name }} Logo" class="img-fluid rounded me-2" style="width: 25px; height: 25px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-light rounded d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px;">
                                                            <i class="fas fa-shield-alt text-muted" style="font-size: 12px;"></i>
                                                        </div>
                                                    {% endif %}
                                                    <span class="fw-bold">{{ standing.team.name }}</span>
                                                </div>
                                            </td>
                                            <td class="text-center fw-bold">{{ standing.matches_played }}</td>
                                            <td class="text-center text-success fw-bold">{{ standing.wins }}</td>
                                            <td class="text-center text-warning fw-bold">{{ standing.draws }}</td>
                                            <td class="text-center text-danger fw-bold">{{ standing.losses }}</td>
                                            <td class="text-center fw-bold">{{ standing.goals_for }}</td>
                                            <td class="text-center fw-bold">{{ standing.goals_against }}</td>
                                            <td class="text-center">
                                                {% if standing.goal_difference > 0 %}
                                                    <span class="text-success fw-bold">+{{ standing.goal_difference }}</span>
                                                {% elif standing.goal_difference < 0 %}
                                                    <span class="text-danger fw-bold">{{ standing.goal_difference }}</span>
                                                {% else %}
                                                    <span class="text-muted fw-bold">0</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary fs-6 px-2 py-1">{{ standing.points }}</span>
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeTeamFromGroup('{{ standing.team.id }}')" title="Remove from group">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                                                 </div>
                         
                         
                         <!-- Group Matches -->
                         {% set group_matches = tournament.matches|selectattr('group_name', 'equalto', group.name)|list %}
                        {% if group_matches %}
                        <div class="matches-section mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-muted mb-0">
                                    <i class="fas fa-gamepad me-2 text-success"></i>
                                    Group {{ group.name }} Matches
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-warning btn-sm" onclick="generateGroupMatches({{ group.id }}, '{{ group.name }}')">
                                        <i class="fas fa-magic me-1"></i> Generate All
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="showScheduleMatchModal('{{ group.name }}')">
                                        <i class="fas fa-plus me-1"></i> Schedule Match
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Field</th>
                                            <th>Time</th>
                                            <th>Home Team</th>
                                            <th>Score</th>
                                            <th>Away Team</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for match in group_matches %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-info fs-6 px-3 py-2">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    Field {{ match.field if match.field else 'TBD' }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="fw-bold text-primary">
                                                        {{ match.date.strftime('%H:%M') if match.date else 'TBD' }}
                                                    </div>
                                                    <small class="text-muted">
                                                        {{ match.date.strftime('%d/%m') if match.date else '' }}
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if match.home_team and match.home_team.logo_url %}
                                                        <img src="{{ match.home_team.logo_url }}" alt="Logo" class="me-2 rounded" style="width: 25px; height: 25px; object-fit: cover;">
                                                    {% else %}
                                                        <i class="fas fa-shield-alt me-2 text-primary"></i>
                                                    {% endif %}
                                                    <span class="fw-bold">{{ match.home_team.name if match.home_team else 'TBD' }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                {% if match.status == 'completed' %}
                                                    <span class="badge bg-success fs-6 px-3 py-2">{{ match.home_score }} - {{ match.away_score }}</span>
                                                {% else %}
                                                    <span class="text-muted fw-bold">vs</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="fw-bold me-2">{{ match.away_team.name if match.away_team else 'TBD' }}</span>
                                                    {% if match.away_team and match.away_team.logo_url %}
                                                        <img src="{{ match.away_team.logo_url }}" alt="Logo" class="ms-2 rounded" style="width: 25px; height: 25px; object-fit: cover;">
                                                    {% else %}
                                                        <i class="fas fa-shield-alt ms-2 text-primary"></i>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if match.status == 'completed' else 'warning' if match.status == 'scheduled' else 'secondary' }} px-3 py-2">
                                                    {{ match.status|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if match.status == 'scheduled' %}
                                                        <button class="btn btn-outline-primary" onclick="showUpdateScoreModal('{{ match.id }}', '{{ match.home_team.name if match.home_team else 'TBD' }}', '{{ match.away_team.name if match.away_team else 'TBD' }}')" title="Update Score">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    {% endif %}
                                                    <button class="btn btn-outline-danger" onclick="deleteMatch('{{ match.id }}')" title="Delete Match">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="matches-section mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-muted mb-0">
                                    <i class="fas fa-gamepad me-2 text-success"></i>
                                    Group {{ group.name }} Matches
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-warning btn-sm" onclick="generateGroupMatches({{ group.id }}, '{{ group.name }}')">
                                        <i class="fas fa-magic me-1"></i> Generate All
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="showScheduleMatchModal('{{ group.name }}')">
                                        <i class="fas fa-plus me-1"></i> Schedule Match
                                    </button>
                                </div>
                            </div>
                            <div class="text-center py-3">
                                <i class="fas fa-gamepad fa-2x text-muted mb-2"></i>
                                <p class="text-muted small mb-0">No matches scheduled yet</p>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-group text-center py-5">
                            <div class="empty-icon mb-3">
                                <i class="fas fa-users fa-4x text-muted opacity-50"></i>
                            </div>
                            <h5 class="text-muted mb-2">No teams assigned yet</h5>
                            <p class="text-muted mb-0">Use the dropdown above to add teams to Group {{ group.name }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Teams Tab -->
        <div class="tab-pane fade" id="teams" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>All Tournament Teams</h3>
                <a href="{{ url_for('team.new_team') }}?tournament_id={{ tournament.id }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Team
                </a>
            </div>
            
            {% if tournament.teams %}
                <div class="row">
                    {% for team in tournament.teams %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="me-3">
                                        {% if team.logo_url %}
                                            <img src="{{ team.logo_url }}" alt="{{ team.name }} Logo" class="img-fluid" style="max-height: 40px; max-width: 40px;">
                                        {% else %}
                                            <i class="fas fa-shield-alt fa-2x text-primary"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="card-title mb-0">{{ team.name }}</h6>
                                        <small class="text-muted">
                                            {% if team.group %}
                                                Group {{ team.group.name }}
                                            {% else %}
                                                No Group Assigned
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                                <div class="row text-center mb-2">
                                    <div class="col-6">
                                        <small class="text-muted">Country</small>
                                        <div class="fw-bold">{{ team.country }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">City</small>
                                        <div class="fw-bold">{{ team.city }}</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <a href="{{ url_for('team.view_team', team_id=team.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                    {% if team.group %}
                                        <button class="btn btn-outline-warning btn-sm" onclick="removeTeamFromGroup('{{ team.id }}')">
                                            <i class="fas fa-times"></i> Remove from Group
                                        </button>
                                    {% else %}
                                        <div class="mt-2">
                                            <label for="assignGroup{{ team.id }}" class="form-label small text-muted">Assign to Group:</label>
                                            <select class="form-select form-select-sm" id="assignGroup{{ team.id }}" onchange="addTeamToGroup(this.value, '{{ team.id }}')">
                                                <option value="">Choose group...</option>
                                                <option value="A">Group A</option>
                                                <option value="B">Group B</option>
                                                <option value="C">Group C</option>
                                                <option value="D">Group D</option>
                                            </select>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No teams yet</h4>
                    <p class="text-muted">Add teams to this tournament to get started!</p>
                    <a href="{{ url_for('team.new_team') }}?tournament_id={{ tournament.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Team
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Matches Tab -->
        <div class="tab-pane fade" id="matches" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Tournament Matches</h3>
                <div>
                    <a href="{{ url_for('match.new_match') }}?tournament_id={{ tournament.id }}" class="btn btn-primary me-2">
                        <i class="fas fa-plus"></i> Add Match
                    </a>
                    <form method="POST" action="{{ url_for('tournament.generate_matches', tournament_id=tournament.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-magic"></i> Generate Group Matches
                        </button>
                    </form>
                </div>
            </div>
            
            {% if tournament.matches %}
                <!-- Group by Stage -->
                {% set stages = ['group_stage', 'round_of_16', 'quarter_final', 'semi_final', 'final'] %}
                {% for stage in stages %}
                    {% set stage_matches = tournament.matches|selectattr('stage', 'equalto', stage)|list %}
                    {% if stage_matches %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-layer-group me-2"></i>{{ stage|replace('_', ' ')|title }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Home Team</th>
                                            <th>Score</th>
                                            <th>Away Team</th>
                                            <th>Group</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for match in stage_matches|sort(attribute='date') %}
                                        <tr>
                                            <td>{{ match.date.strftime('%B %d, %Y') if match.date else 'TBD' }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if match.home_team and match.home_team.logo_url %}
                                                        <img src="{{ match.home_team.logo_url }}" alt="Logo" class="me-2" style="max-height: 20px;">
                                                    {% else %}
                                                        <i class="fas fa-shield-alt me-2 text-primary"></i>
                                                    {% endif %}
                                                    {{ match.home_team.name if match.home_team else 'TBD' }}
                                                </div>
                                            </td>
                                            <td>
                                                {% if match.status == 'completed' %}
                                                    <span class="badge bg-success">{{ match.home_score }} - {{ match.away_score }}</span>
                                                {% else %}
                                                    <span class="text-muted">vs</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if match.away_team and match.away_team.logo_url %}
                                                        <img src="{{ match.away_team.logo_url }}" alt="Logo" class="me-2" style="max-height: 20px;">
                                                    {% else %}
                                                        <i class="fas fa-shield-alt me-2 text-primary"></i>
                                                    {% endif %}
                                                    {{ match.away_team.name if match.away_team else 'TBD' }}
                                                </div>
                                            </td>
                                            <td>
                                                {% if match.group_name %}
                                                    <span class="badge bg-info">Group {{ match.group_name }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if match.status == 'completed' else 'warning' if match.status == 'scheduled' else 'secondary' }}">
                                                    {{ match.status|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('match.view_match', match_id=match.id) }}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-gamepad fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No matches yet</h4>
                    <p class="text-muted">Add matches to this tournament or generate them automatically!</p>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="{{ url_for('match.new_match') }}?tournament_id={{ tournament.id }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Match
                        </a>
                        <form method="POST" action="{{ url_for('tournament.generate_matches', tournament_id=tournament.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-magic"></i> Generate Matches
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Standings Tab -->
        <div class="tab-pane fade" id="standings" role="tabpanel">
            <h3>Tournament Standings</h3>
            {% if tournament.teams %}
                {% set standings = tournament.get_standings() %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>Group</th>
                                <th>P</th>
                                <th>W</th>
                                <th>D</th>
                                <th>L</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for standing in standings %}
                            <tr>
                                <td class="fw-bold">{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-shield-alt me-2 text-primary"></i>
                                        {{ standing.name }}
                                    </div>
                                </td>
                                <td>
                                    {% if standing.group_name %}
                                        <span class="badge bg-info">Group {{ standing.group_name }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ standing.matches_played }}</td>
                                <td class="text-success">{{ standing.wins }}</td>
                                <td class="text-warning">{{ standing.draws }}</td>
                                <td class="text-danger">{{ standing.losses }}</td>
                                <td>{{ standing.goals_for }}</td>
                                <td>{{ standing.goals_against }}</td>
                                <td class="fw-bold">{{ standing.goal_difference }}</td>
                                <td class="fw-bold text-primary">{{ standing.points }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-list-ol fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No standings available</h4>
                    <p class="text-muted">Add teams and complete matches to see standings!</p>
                </div>
            {% endif %}
        </div>

                 <!-- Bracket Tab -->
         <div class="tab-pane fade" id="bracket" role="tabpanel">
             <h3>Tournament Bracket</h3>
             <div class="text-center py-5">
                 <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                 <h4 class="text-muted">Bracket View</h4>
                 <p class="text-muted">Tournament bracket will be displayed here once knockout stages begin.</p>
                 <div class="d-flex justify-content-center gap-2">
                     {% if tournament.can_start_knockout() %}
                     <a href="{{ url_for('tournament.knockout_management', tournament_id=tournament.id) }}" class="btn btn-warning">
                         <i class="fas fa-trophy me-2"></i>Manage Knockout Stage
                     </a>
                     {% endif %}
                     <a href="{{ url_for('tournament.tournament_bracket', tournament_id=tournament.id) }}" class="btn btn-primary">
                         <i class="fas fa-eye me-2"></i>View Full Bracket
                     </a>
                 </div>
             </div>
         </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 pt-3 border-top">
        <div class="d-flex gap-2">
                             <a href="{{ url_for('tournament.edit_tournament', tournament_id=tournament.id) }}" class="btn btn-outline-primary">
                     <i class="fas fa-edit"></i> Edit Tournament
                 </a>
                 <a href="{{ url_for('tournament.manage_groups', tournament_id=tournament.id) }}" class="btn btn-info">
                     <i class="fas fa-layer-group"></i> Manage Groups
                 </a>
                 <a href="{{ url_for('tournament.manage_qualification', tournament_id=tournament.id) }}" class="btn btn-warning">
                     <i class="fas fa-users"></i> Team Qualification
                 </a>
                 {% if tournament.get_qualified_teams()|length > 0 %}
                 <a href="{{ url_for('tournament.knockout_management', tournament_id=tournament.id) }}" class="btn btn-success">
                     <i class="fas fa-trophy"></i> Knockout Stage
                 </a>
                 {% endif %}
                 <a href="{{ url_for('main.tournaments') }}" class="btn btn-outline-secondary">
                     <i class="fas fa-arrow-left"></i> Back to Tournaments
                 </a>
        </div>
    </div>

    <!-- Schedule Match Modal -->
    <div class="modal fade" id="scheduleMatchModal" tabindex="-1" aria-labelledby="scheduleMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="scheduleMatchModalLabel">
                        <i class="fas fa-calendar-plus me-2"></i>Schedule New Match
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleMatchForm">
                        <input type="hidden" id="matchGroupName" name="group_name">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="homeTeam" class="form-label">Home Team</label>
                                <select class="form-select" id="homeTeam" name="home_team_id" required>
                                    <option value="">Select home team...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="awayTeam" class="form-label">Away Team</label>
                                <select class="form-select" id="awayTeam" name="away_team_id" required>
                                    <option value="">Select away team...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="matchDate" class="form-label">Match Date & Time</label>
                                <input type="datetime-local" class="form-control" id="matchDate" name="date" required>
                            </div>
                            <div class="col-md-4">
                                <label for="matchField" class="form-label">Field</label>
                                <select class="form-select" id="matchField" name="field" required>
                                    <option value="">Select field...</option>
                                    <option value="1">Field 1</option>
                                    <option value="2">Field 2</option>
                                    <option value="3">Field 3</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="matchVenue" class="form-label">Venue (Optional)</label>
                                <input type="text" class="form-control" id="matchVenue" name="venue" placeholder="Stadium name">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> This match will be automatically assigned to the selected group and set as "Scheduled".
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="scheduleMatch()">
                        <i class="fas fa-calendar-check me-2"></i>Schedule Match
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Score Modal -->
    <div class="modal fade" id="updateScoreModal" tabindex="-1" aria-labelledby="updateScoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="updateScoreModalLabel">
                        <i class="fas fa-edit me-2"></i>Update Match Score
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateScoreForm">
                        <input type="hidden" id="matchId" name="match_id">
                        <div class="text-center mb-4">
                            <h6 class="text-muted">Match Details</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-center">
                                    <div class="fw-bold" id="homeTeamName">Home Team</div>
                                </div>
                                <div class="text-muted">vs</div>
                                <div class="text-center">
                                    <div class="fw-bold" id="awayTeamName">Away Team</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="homeScore" class="form-label">Home Team Score</label>
                                <input type="number" class="form-control text-center" id="homeScore" name="home_score" min="0" required>
                            </div>
                            <div class="col-6">
                                <label for="awayScore" class="form-label">Away Team Score</label>
                                <input type="number" class="form-control text-center" id="awayScore" name="away_score" min="0" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="matchDateTime" class="form-label">Data e Horário</label>
                                <input type="datetime-local" class="form-control" id="matchDateTime" name="match_datetime">
                            </div>
                            <div class="col-6">
                                <label for="fieldNumber" class="form-label">Número do Campo</label>
                                <input type="text" class="form-control" id="fieldNumber" name="field_number" placeholder="Ex: Campo 1, Campo 2...">
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> Updating the score will mark this match as completed and update the standings.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateMatchScore()">
                        <i class="fas fa-save me-2"></i>Update Score
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom Group Design Styles */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.team-card {
    transition: all 0.3s ease;
    border-radius: 12px;
}

.team-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}

.add-team-section, .group-stats {
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.add-team-section:hover, .group-stats:hover {
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.stat-item {
    padding: 10px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.stat-item:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.05);
}

.team-logo-placeholder {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
    transition: all 0.2s ease;
}

.empty-group {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 2px dashed #dee2e6;
}

.empty-icon {
    opacity: 0.6;
}

.btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-color: #dc3545;
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.form-select-lg:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem !important;
    }
    
    .stat-item {
        margin-bottom: 10px;
    }
    
    .team-card {
        margin-bottom: 1rem;
    }
}
</style>

<script>
function addTeamToGroup(groupName, teamId) {
    if (!groupName || !teamId) return;
    
    console.log('Adding team', teamId, 'to group', groupName);
    
    fetch(`/team/${teamId}/assign-group`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ group_name: groupName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset the dropdown
            const dropdown = document.getElementById(`addTeam${groupName}`);
            if (dropdown) dropdown.value = '';
            
            // Show success message
            alert(`Team successfully added to Group ${groupName}!`);
            
            // Reload the page to show updated groups
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding team to group. Please try again.');
    });
}

function removeTeamFromGroup(teamId) {
    if (!confirm('Are you sure you want to remove this team from its group?')) return;
    
    console.log('Removing team', teamId, 'from group');
    
    fetch(`/team/${teamId}/assign-group`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ group_name: null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Team removed from group successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing team from group. Please try again.');
    });
}

// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tournament view page loaded with beautiful new group design and match management');
    
    // Add smooth animations
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });
    
    // Set default date to today for new matches
    const today = new Date();
    const dateString = today.toISOString().slice(0, 16);
    document.getElementById('matchDate').value = dateString;
});

// Match Management Functions
function showScheduleMatchModal(groupName) {
    document.getElementById('matchGroupName').value = groupName;
    
    // Populate team dropdowns with teams from this group
    const homeTeamSelect = document.getElementById('homeTeam');
    const awayTeamSelect = document.getElementById('awayTeam');
    
    // Clear existing options
    homeTeamSelect.innerHTML = '<option value="">Select home team...</option>';
    awayTeamSelect.innerHTML = '<option value="">Select away team...</option>';
    
    // Get teams that are actually IN this specific group
    const groupTeams = Array.from(document.querySelectorAll('.team-card'))
        .filter(card => {
            // Check if this team card is within the correct group section
            const groupSection = card.closest('.card.mb-4.border-0.shadow-sm');
            if (!groupSection) return false;
            
            const groupHeader = groupSection.querySelector('.card-header h4');
            if (!groupHeader) return false;
            
            const headerText = groupHeader.textContent.trim();
            return headerText.includes(`Group ${groupName}`);
        })
        .map(card => {
            const teamName = card.querySelector('.card-title').textContent.trim();
            // Extract team ID from the remove button onclick attribute
            const removeBtn = card.querySelector('button[onclick*="removeTeamFromGroup"]');
            if (!removeBtn) return null;
            
            const teamId = removeBtn.onclick.toString().match(/'(\d+)'/);
            if (!teamId) return null;
            
            return { id: teamId[1], name: teamName };
        })
        .filter(team => team !== null);
    
    // Add teams to both dropdowns
    groupTeams.forEach(team => {
        homeTeamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
        awayTeamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
    });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('scheduleMatchModal'));
    modal.show();
}

function scheduleMatch() {
    const form = document.getElementById('scheduleMatchForm');
    const formData = new FormData(form);
    
    const matchData = {
        tournament_id: {{ tournament.id }},
        home_team_id: formData.get('home_team_id'),
        away_team_id: formData.get('away_team_id'),
        date: formData.get('date'),
        field: formData.get('field'),
        venue: formData.get('venue'),
        group_name: formData.get('group_name'),
        stage: 'group_stage',
        status: 'scheduled'
    };
    
    if (!matchData.home_team_id || !matchData.away_team_id || !matchData.date || !matchData.field) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (matchData.home_team_id === matchData.away_team_id) {
        alert('Home team and away team cannot be the same');
        return;
    }
    
    fetch('/match/new', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(matchData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match scheduled successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling match. Please try again.');
    });
}

function showUpdateScoreModal(matchId, homeTeamName, awayTeamName) {
    document.getElementById('matchId').value = matchId;
    document.getElementById('homeTeamName').textContent = homeTeamName;
    document.getElementById('awayTeamName').textContent = awayTeamName;
    
    // Clear previous scores
    document.getElementById('homeScore').value = '';
    document.getElementById('awayScore').value = '';
    
    // Fetch current match data to populate datetime and field
    fetch(`/match/${matchId}/data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate datetime field
                if (data.match.date) {
                    const date = new Date(data.match.date);
                    const isoString = date.toISOString().slice(0, 16); // Format for datetime-local
                    document.getElementById('matchDateTime').value = isoString;
                }
                
                // Populate field number
                if (data.match.field) {
                    document.getElementById('fieldNumber').value = data.match.field;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching match data:', error);
        });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('updateScoreModal'));
    modal.show();
}

function updateMatchScore() {
    const form = document.getElementById('updateScoreForm');
    const formData = new FormData(form);
    
    const scoreData = {
        match_id: formData.get('match_id'),
        home_score: parseInt(formData.get('home_score')),
        away_score: parseInt(formData.get('away_score')),
        match_datetime: formData.get('match_datetime'),
        field_number: formData.get('field_number')
    };
    
    if (scoreData.home_score < 0 || scoreData.away_score < 0) {
        alert('Scores cannot be negative');
        return;
    }
    
    fetch(`/match/${scoreData.match_id}/update-score`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scoreData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Score updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating score. Please try again.');
    });
}

function deleteMatch(matchId) {
    if (!confirm('Are you sure you want to delete this match? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/match/${matchId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting match. Please try again.');
    });
}

// Generate Matches Functions
function generateGroupMatches(groupId, groupName) {
    if (!confirm(`Are you sure you want to generate all matches for Group ${groupName}? This will create matches where each team plays every other team once.`)) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';
    button.disabled = true;
    
    fetch(`/tournament/{{ tournament.id }}/generate-group-matches`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            group_id: groupId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Success! Generated ${data.matches_created} matches for Group ${groupName}.`);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating matches. Please try again.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function generateAllGroupMatches() {
    if (!confirm('Are you sure you want to generate all matches for ALL groups? This will create matches where each team plays every other team in their group once.')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Generating All Matches...';
    button.disabled = true;
    
    fetch(`/tournament/{{ tournament.id }}/generate-all-group-matches`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Success! Generated ${data.matches_created} matches for ${data.groups_processed.length} groups.`);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating matches. Please try again.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}

