{% extends "base.html" %}

{% block title %}Knockout Stage - Soccer Championship Manager{% endblock %}

{% block extra_css %}
<style>
    .knockout-container {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .tournament-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .tournament-header {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #1a1a2e;
        padding: 1.5rem;
        text-align: center;
    }
    
    .tournament-title {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 0;
    }
    
    .qualified-teams {
        padding: 2rem;
    }
    
    .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .team-card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .team-card:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    .team-card.selected {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #1a1a2e;
        border-color: #ffd700;
    }
    
    .team-logo {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        margin: 0 auto 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .team-name {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .team-group {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .knockout-actions {
        text-align: center;
        padding: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-knockout {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #1a1a2e;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .btn-knockout:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        color: #1a1a2e;
    }
    
    .btn-knockout:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .selection-info {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="knockout-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="text-white mb-3">
                        <i class="fas fa-sitemap me-3"></i>
                        Knockout Stage
                    </h1>
                    <p class="text-white-50">Gerencie os confrontos eliminatórios dos torneios</p>
                </div>
            </div>
        </div>
        
        {% if tournament_data %}
            {% for data in tournament_data %}
            <div class="row">
                <div class="col-12">
                    <div class="tournament-card">
                        <div class="tournament-header">
                            <h2 class="tournament-title">{{ data.tournament.name }}</h2>
                            <p class="mb-0">{{ data.qualified_teams|length }} times classificados</p>
                        </div>
                        
                        <div class="qualified-teams">
                            <div class="selection-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Selecione os times para criar os confrontos do knockout</strong>
                                <br>
                                <small>Clique nos times para selecioná-los. Você pode criar confrontos personalizados.</small>
                            </div>
                            
                            <div class="team-grid" id="teamGrid-{{ data.tournament.id }}">
                                {% for team in data.qualified_teams %}
                                <div class="team-card" 
                                     data-team-id="{{ team.id }}" 
                                     data-team-name="{{ team.name }}"
                                     data-tournament-id="{{ data.tournament.id }}"
                                     onclick="toggleTeamSelection(this)">
                                    <div class="team-logo">
                                        {% if team.logo_url %}
                                            <img src="{{ team.logo_url }}" alt="{{ team.name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                        {% else %}
                                            {{ team.name[:2].upper() }}
                                        {% endif %}
                                    </div>
                                    <div class="team-name">{{ team.name }}</div>
                                    <div class="team-group">Grupo {{ team.group_name }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="knockout-actions">
                                <a href="{{ url_for('tournament.knockout_management', tournament_id=data.tournament.id) }}" 
                                   class="btn-knockout" 
                                   id="knockoutBtn-{{ data.tournament.id }}"
                                   onclick="return checkTeamSelection({{ data.tournament.id }})">
                                    <i class="fas fa-sitemap me-2"></i>
                                    Criar Chaveamento
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="row">
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <h3>Nenhum torneio com times classificados</h3>
                        <p>Configure a qualificação dos times nos torneios para ver o chaveamento knockout.</p>
                        <a href="{{ url_for('main.tournaments') }}" class="btn btn-primary">
                            <i class="fas fa-trophy me-2"></i>
                            Ver Torneios
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
let selectedTeams = {};

function toggleTeamSelection(element) {
    const teamId = element.dataset.teamId;
    const teamName = element.dataset.teamName;
    const tournamentId = element.dataset.tournamentId;
    
    if (!selectedTeams[tournamentId]) {
        selectedTeams[tournamentId] = [];
    }
    
    const teamIndex = selectedTeams[tournamentId].findIndex(team => team.id === teamId);
    
    if (teamIndex > -1) {
        // Remove team from selection
        selectedTeams[tournamentId].splice(teamIndex, 1);
        element.classList.remove('selected');
    } else {
        // Add team to selection
        selectedTeams[tournamentId].push({
            id: teamId,
            name: teamName
        });
        element.classList.add('selected');
    }
    
    updateKnockoutButton(tournamentId);
}

function updateKnockoutButton(tournamentId) {
    const btn = document.getElementById(`knockoutBtn-${tournamentId}`);
    const selectedCount = selectedTeams[tournamentId] ? selectedTeams[tournamentId].length : 0;
    
    if (selectedCount === 0) {
        btn.textContent = 'Criar Chaveamento';
        btn.disabled = true;
    } else {
        btn.textContent = `Criar Chaveamento (${selectedCount} times selecionados)`;
        btn.disabled = false;
    }
}

function checkTeamSelection(tournamentId) {
    const selectedCount = selectedTeams[tournamentId] ? selectedTeams[tournamentId].length : 0;
    
    if (selectedCount === 0) {
        alert('Selecione pelo menos um time para criar o chaveamento!');
        return false;
    }
    
    if (selectedCount % 2 !== 0) {
        alert('Selecione um número par de times para criar confrontos equilibrados!');
        return false;
    }
    
    // Store selected teams in sessionStorage for the knockout page
    sessionStorage.setItem(`selectedTeams_${tournamentId}`, JSON.stringify(selectedTeams[tournamentId]));
    return true;
}

// Initialize buttons
document.addEventListener('DOMContentLoaded', function() {
    const tournamentCards = document.querySelectorAll('[id^="knockoutBtn-"]');
    tournamentCards.forEach(btn => {
        const tournamentId = btn.id.split('-')[1];
        updateKnockoutButton(tournamentId);
    });
});
</script>
{% endblock %}
